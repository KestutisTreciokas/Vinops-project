# vinops.online — API v1 Mapping (DB → DTO)

**Версия:** 2025-09-23 23:50 (Europe/Warsaw)  
**Инварианты:** read-only; VIN 11–17 UPPER ^[A-HJ-NPR-Z0-9]{11,17}$; suppress → 410; breaking → /api/v2.

## 1. Сущности и таблицы (Core)

- vehicles(vin PK, year, make, model, trim, body, fuel, transmission, drive, engine, color, odometer_value, odometer_unit, odometer_brand)
- lots(lot_id PK, vin FK, source, status, site_code, city, region, country, auction_datetime_utc, est_retail_value_usd, runs_drives, has_keys, damage_primary, damage_secondary, title_brand, title_state, odo_value, odo_unit, odo_brand)
- sale_events(id PK, vin FK, lot_id FK, sale_date, status, final_bid_usd, currency, collected_via)
- images(id PK, vin FK, lot_id FK, seq, variant, storage_key, source_url, width, height, bytes, content_hash)

## 2. VehicleAggregate → DTO

| DTO путь                              | Источник (таблица.колонка/логика)            | Тип       | Примечание |
|---------------------------------------|----------------------------------------------|-----------|------------|
| vehicle.vin                           | vehicles.vin                                  | string    | UPPER |
| vehicle.year                          | vehicles.year                                 | int?      |            |
| vehicle.make                          | vehicles.make                                 | string?   | EN code |
| vehicle.model                         | vehicles.model                                | string?   | EN code |
| vehicle.trim                          | vehicles.trim                                 | string?   |            |
| vehicle.body                          | vehicles.body                                 | string?   | EN code |
| vehicle.fuel                          | vehicles.fuel                                 | string?   | EN code |
| vehicle.transmission                  | vehicles.transmission                          | string?   | EN code |
| vehicle.drive                         | vehicles.drive                                 | string?   | EN code |
| vehicle.engine                        | vehicles.engine                                | string?   |            |
| vehicle.color                         | vehicles.color                                 | string?   | EN code |
| vehicle.odometer.value                | vehicles.odometer_value                        | int?      |            |
| vehicle.odometer.unit                 | vehicles.odometer_unit                         | enum?     | mi|km |
| vehicle.odometer.brand                | vehicles.odometer_brand                        | enum?     | ACTUAL/NOT_ACTUAL/EXEMPT/UNKNOWN |
| currentLot.lotId                      | lots.lot_id                                    | int       | текущий активный/последний |
| currentLot.vin                        | lots.vin                                       | string    |            |
| currentLot.source                     | lots.source                                    | enum      | copart |
| currentLot.status                     | lots.status                                    | enum      | см. OpenAPI |
| currentLot.siteCode                   | lots.site_code                                 | string?   |            |
| currentLot.city                       | lots.city                                      | string?   |            |
| currentLot.region                     | lots.region                                    | string?   |            |
| currentLot.country                    | lots.country                                   | string?   | ISO2 |
| currentLot.auctionDateTimeUtc         | lots.auction_datetime_utc                      | datetime? | UTC ISO8601 |
| currentLot.estRetailValueUsd          | lots.est_retail_value_usd                      | number?   | USD |
| currentLot.runsDrives                 | lots.runs_drives                               | bool?     |            |
| currentLot.hasKeys                    | lots.has_keys                                  | bool?     |            |
| currentLot.damagePrimary              | lots.damage_primary                             | string?   | EN code |
| currentLot.damageSecondary            | lots.damage_secondary                           | string?   | EN code |
| currentLot.titleBrand                 | lots.title_brand                                | string?   | EN code |
| currentLot.titleState                 | lots.title_state                                | string?   | ISO2 US state |
| currentLot.odometer.value             | lots.odo_value                                  | int?      |            |
| currentLot.odometer.unit              | lots.odo_unit                                   | enum?     | mi|km |
| currentLot.odometer.brand             | lots.odo_brand                                  | enum?     | ACTUAL/NOT_ACTUAL/EXEMPT/UNKNOWN |
| images[].seq                          | images.seq                                      | int       |            |
| images[].variant                      | images.variant                                  | enum      | thumb/md/xl/orig |
| images[].url                          | images.storage_key → публичный URL             | uri       | img.vinops.online |
| images[].width                        | images.width                                    | int?      |            |
| images[].height                       | images.height                                   | int?      |            |
| saleEvents[].id                       | sale_events.id                                  | string?   |            |
| saleEvents[].vin                      | sale_events.vin                                 | string    |            |
| saleEvents[].lotId                    | sale_events.lot_id                              | int       |            |
| saleEvents[].saleDate                 | sale_events.sale_date                           | date      | YYYY-MM-DD |
| saleEvents[].status                   | sale_events.status                              | enum      | SOLD/NO_SALE/CANCELLED/RELISTED |
| saleEvents[].finalBidUsd              | sale_events.final_bid_usd                       | number?   | USD |
| saleEvents[].currency                 | sale_events.currency                            | enum?     | USD |
| saleEvents[].collectedVia             | sale_events.collected_via                       | enum?     | live/heuristics |

## 3. LotCardDto (search items[]) → DTO

| DTO поле              | Источник                      | Тип     | Примечание |
|-----------------------|-------------------------------|---------|------------|
| lotId                 | lots.lot_id                   | int     |            |
| vin                   | lots.vin                      | string  |            |
| year                  | vehicles.year                 | int?    |            |
| make                  | vehicles.make                 | string? | EN code |
| model                 | vehicles.model                | string? | EN code |
| trim                  | vehicles.trim                 | string? |            |
| status                | lots.status                   | enum    |            |
| siteCode              | lots.site_code                | string? |            |
| city                  | lots.city                     | string? |            |
| region                | lots.region                   | string? |            |
| country               | lots.country                  | string? | ISO2 |
| auctionDateTimeUtc    | lots.auction_datetime_utc     | dt?     | UTC |
| estRetailValueUsd     | lots.est_retail_value_usd     | number? | USD |
| runsDrives            | lots.runs_drives              | bool?   |            |
| hasKeys               | lots.has_keys                 | bool?   |            |
| primaryImageUrl       | images.variant='xl' seq=1     | uri?    | предпочтительный кадр |
| imageCount            | COUNT(images.* WHERE lot_id)  | int?    |            |

## 4. Статусы/словари (EN code)

- `LotDto.status`: FUTURE, SCHEDULED, LIVE, ON_APPROVAL, SOLD, NO_SALE, CANCELLED, RELISTED.
- `Odometer.brand`: ACTUAL, NOT_ACTUAL, EXEMPT, UNKNOWN.
- `ImageDto.variant`: thumb, md, xl, orig.

## 5. Ошибки / коды

- 404 NOT_FOUND (VIN отсутствует), 410 suppressed, 422 INVALID_VIN/VALIDATION_ERROR, 429 RATE_LIMITED, 400 BAD_REQUEST (search), 500 SERVER_ERROR.  
Тело: `{ "error": { "code": "<UPPER_SNAKE>", "message": "<human readable>" } }`.

## 6. Ссылки

- Контракт: `contracts/openapi.yaml` (v1, read-only)  
- SSOT §§2.1/2.5/2.7/4/4.6/6
