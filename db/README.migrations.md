# Миграции vinops — конвенции и журнал

## Нумерация и порядок
- Базовый файл: `0001_init.sql`.
- Дальше — монотонные номера с префиксом: `0002_constraints.sql`, `0003_indexes.sql`, `0004_*.sql`, …
- Миграции **идемпотентны**: используем `IF NOT EXISTS`/`IF EXISTS` и не выполняем деструктивных действий.
- Применение — только вперёд: `0001` → `0002` → `0003` → …
- Откаты — **только документированные** (см. блок *Rollback strategy* в каждом файле) и отдельно согласованные.

## Содержимое миграций
- `0001_init.sql` — базовые таблицы без ограничений, без потерь данных.
- `0002_constraints.sql` — PK/FK/CHECK + обязательные уникальности; **без** удаления/переименований столбцов.
- `0003_indexes.sql` — индексы под чтение каталога и карточки VIN.
- Дальнейшие файлы — отдельными инкрементами (политики, дополнительные индексы, расширения полей и т.п.).

## Rollback strategy (общая)
- Индексы — снимаются `DROP INDEX IF EXISTS ...;`
- CHECK/PK/FK — откатываются `ALTER TABLE ... DROP CONSTRAINT IF EXISTS ...;`
- Любые деструктивные операции на данных запрещены в S-02; правки данных — отдельные спринты/миграции.

## Реестр
- Технический реестр хранится в `db/migrations/_registry.json` и обновляется вместе с миграциями.
- Поля реестра: `id`, `file`, `purpose`, `rollback`, `timestamp_tz` (Europe/Warsaw).
