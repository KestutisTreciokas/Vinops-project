{
  email request@vinops.online
}

vinops.online, www.vinops.online {
  encode zstd gzip

  # Security headers (оставляем как было)
  header {
    defer
    -X-Powered-By
    X-Frame-Options "SAMEORIGIN"
    X-Content-Type-Options "nosniff"
    Referrer-Policy "strict-origin-when-cross-origin"
    Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    Content-Security-Policy-Report-Only "default-src 'self'; img-src 'self' https: data: blob:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; connect-src 'self' https:; font-src 'self' data:; frame-ancestors 'self'"
  }

  # Исключения статических/служебных путей — не редиректим
  @static path /favicon.ico /icon.svg /robots.txt /sitemap.xml /sitemap* /jsonld* /_next/* /assets/* /svg/* /api/* /cdn-cgi/*

  # Корень → /en (строгий 308)
  @root path /
  redir @root /en 308

  # Без /en|/ru → редирект на /en{uri}
  @noLocale {
    not path_regexp hasLocale ^/(en|ru)(/|$)
    not path /favicon.ico /icon.svg /robots.txt /sitemap.xml /sitemap* /jsonld* /_next/* /assets/* /svg/* /api/* /cdn-cgi/*
  }
  redir @noLocale /en{uri} 308

  # Статику и остальное проксируем в Next
  handle @static {
    reverse_proxy web:3000
  }
  reverse_proxy web:3000
}

# --- dev host block [MS-0.5-03] ---
dev.vinops.online {
  @root path /
  redir @root /en 308

  # отдельный dev-бэкенд на docker-сети vinops_dev_net
  reverse_proxy vinops-dev-web:3000

  # за CF-прокси достаточно Origin TLS
  tls internal
}
# --- end dev host block ---
